---
import Layout from '../layouts/Layout.astro';
import { getAirlineRoutesWithAirports } from '../data/route.ts';

const airlinesData = await import('../assets/airlines.json');
const airlines = airlinesData.airlines;

// Load all routes and airports for client-side filtering
let airports = {};
let allRoutes = [];

try {
  const airportData = await import('../assets/airport_database_processed.csv?raw');
  
  const allAirlineRoutes = [];
  for (const airline of airlines) {
    const data = await getAirlineRoutesWithAirports(airline.prefix, airportData.default);
    allAirlineRoutes.push(...data.routes);
    Object.assign(airports, data.airports);
  }
  
  allRoutes = allAirlineRoutes;
  
  const qrRoutes = allRoutes.filter(route => route.fltnum.includes('QR'));
  const usedAirports = new Set();
  qrRoutes.forEach(route => {
    usedAirports.add(route.dep);
    usedAirports.add(route.arr);
  });
  
  const filteredAirports = {};
  Object.entries(airports).forEach(([code, airport]) => {
    if (usedAirports.has(code)) {
      filteredAirports[code] = airport;
    }
  });
  
  airports = filteredAirports;
} catch (error) {
  airports = {
    OTHH: { name: "Doha Hamad Intl", icao: "OTHH", lat: 25.2731, lng: 51.6081 }
  };
  allRoutes = [];
}
---

<Layout>
  <h1 class="text-3xl font-bold text-center">Interactive Route Map</h1>
  <p class="mt-2 text-center">
    Take a look at the routes you could fly!
  </p>

  <!-- Airline selector and search -->
  <div class="flex justify-center items-center gap-4 mt-4">
    <select
      id="airlineSelect"
      class="border border-gray-300 px-4 py-2 rounded shadow-sm"
    >
      {airlines.map(airline => (
        <option value={airline.prefix} selected={airline.prefix === 'QR'}>
          {airline.name}
        </option>
      ))}
    </select>
    <input
      id="airportSearch"
      type="text"
      placeholder="Search airport..."
      class="border border-gray-300 px-4 py-2 rounded w-60 shadow-sm"
    />
  </div>

  <style>
    #map {
      height: 70vh;
      width: 100%;
      margin-top: 1rem;
    }

    .leaflet-popup-content {
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }

    .leaflet-popup-content strong {
      font-weight: bold;
    }
    
    .leaflet-popup {
      max-width: 350px;
    }
  </style>

  <div id="map"></div>

  <!-- Leaflet + plugin -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    client:load
  ></script>
  <script
    src="https://unpkg.com/leaflet-arc/bin/leaflet-arc.min.js"
    client:load
  ></script>

  <!-- Map + search logic -->
  <script define:vars={{ airports, allRoutes, airlines }}>
    if (typeof airports === 'undefined') airports = {};
    if (typeof allRoutes === 'undefined') allRoutes = [];
    if (typeof airlines === 'undefined') airlines = [];
    let currentAirline = airlines.find(a => a.prefix === 'QR');
    let map, markers = {}, drawn = [], connections = {}, routeDetails = {};
    
    function initMap() {
      map = L.map("map").setView([20, 10], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "&copy; OpenStreetMap & CARTO",
          subdomains: "abcd",
        }
      ).addTo(map);
    }
    
    window.onload = function() {
      if (Object.keys(airports).length === 0) {
        airports = {
          OTHH: { name: "Doha Hamad Intl", icao: "OTHH", lat: 25.2731, lng: 51.6081 }
        };
        allRoutes = [];
      }
      
      initMap();
      
      const qrRoutes = allRoutes.filter(route => route.fltnum.includes('QR'));
      
      updateMap(airports, qrRoutes, currentAirline);
      
      // Airline selector
      document.getElementById('airlineSelect').addEventListener('change', (e) => {
        const prefix = e.target.value;
        currentAirline = airlines.find(a => a.prefix === prefix);
        
        // Filter routes for selected airline
        const filteredRoutes = allRoutes.filter(route => route.fltnum.includes(prefix));
        const usedAirports = new Set();
        filteredRoutes.forEach(route => {
          usedAirports.add(route.dep);
          usedAirports.add(route.arr);
        });
        
        // Get all airports (already loaded)
        const allAirportsData = {};
        const neededAirports = new Set();
        allRoutes.forEach(route => {
          neededAirports.add(route.dep);
          neededAirports.add(route.arr);
        });
        
        // Use all available airports, filter by used ones
        const filteredAirports = {};
        Object.keys(airports).forEach(code => {
          if (usedAirports.has(code)) {
            filteredAirports[code] = airports[code];
          }
        });
        
        // Add any missing airports from the full dataset if needed
        usedAirports.forEach(code => {
          if (!filteredAirports[code] && airports[code]) {
            filteredAirports[code] = airports[code];
          }
        });
        
        updateMap(filteredAirports, filteredRoutes, currentAirline);
      });
    };
    
    function updateMap(airportData, routeData, airline) {
      
      // Clear existing data
      Object.values(markers).forEach(m => map.removeLayer(m));
      drawn.forEach(l => map.removeLayer(l));
      markers = {};
      drawn = [];
      connections = {};
      routeDetails = {};
      
      // Build connection map
      Object.keys(airportData).forEach((code) => (connections[code] = new Set()));

      routeData.forEach((route) => {
        const { dep, arr } = route;
        if (airportData[dep] && airportData[arr]) {
          connections[dep].add(arr);
          connections[arr].add(dep);
          
          const routeKey = `${dep}-${arr}`;
          const reverseKey = `${arr}-${dep}`;
          routeDetails[routeKey] = route;
          routeDetails[reverseKey] = route;
        }
      });

      function clearRoutes() {
        drawn.forEach((l) => map.removeLayer(l));
        drawn = [];
      }

      function drawArc(fromCode, toCode) {
        const A = airportData[fromCode];
        const B = airportData[toCode];
        if (!A || !B) return;

        const routeKey = `${fromCode}-${toCode}`;
        const route = routeDetails[routeKey];

        let arc;
        try {
          arc = new L.Polyline.Arc(
            [A.lat, A.lng],
            [B.lat, B.lng],
            {
              color: airline.color,
              weight: 2,
              opacity: 1,
              vertices: 200,
            }
          );
        } catch (e) {
          arc = L.polyline(
            [
              [A.lat, A.lng],
              [B.lat, B.lng],
            ],
            { color: airline.color, weight: 2, opacity: 1 }
          );
        }

        if (route) {
          const duration = Math.floor(route.duration / 60);
          const hours = Math.floor(duration / 60);
          const minutes = duration % 60;
          const flightTime = `${hours}h ${minutes}m`;
          
          const aircraftList = route.aircraft.map(ac => 
            `${ac.name} (${ac.liveryname})`
          ).join('<br>');
          
          const popupContent = `
            <div style="min-width: 200px;">
              <strong>${route.fltnum}</strong><br>
              <strong>${A.name} â†’ ${B.name}</strong><br>
              <strong>Flight Time:</strong> ${flightTime}<br>
              <strong>Aircraft:</strong><br>
              <div style="font-size: 12px; margin-top: 5px;">${aircraftList}</div>
            </div>
          `;
          
          arc.bindPopup(popupContent);
        }

        arc.addTo(map);
        drawn.push(arc);
      }

      function highlightAirport(code) {
        if (!airportData[code]) return;

        clearRoutes();

        const connectedSet = connections[code] || new Set();

        Object.entries(markers).forEach(([otherCode, marker]) => {
          if (otherCode === code) {
            marker.setStyle({ fillOpacity: 1, opacity: 1, radius: 7 });
            marker.bringToFront();
          } else if (connectedSet.has(otherCode)) {
            marker.setStyle({ fillOpacity: 0.9, opacity: 1, radius: 6 });
          } else {
            marker.setStyle({ fillOpacity: 0.2, opacity: 0.3, radius: 5 });
          }
        });

        connectedSet.forEach((dest) => drawArc(code, dest));

        const ap = airportData[code];
        map.flyTo([ap.lat, ap.lng], 4, { duration: 0.7 });
        markers[code].openPopup();
      }

      // Create markers
      Object.entries(airportData).forEach(([code, ap]) => {
        const isHub = airline.hubs.includes(code);
        
        const marker = L.circleMarker([ap.lat, ap.lng], {
          radius: isHub ? 8 : 6,
          fillColor: isHub ? airline.color : "#007bff",
          color: "#ffffff",
          weight: 2,
          fillOpacity: 0.9,
        }).addTo(map);

        const connectedRoutes = routeData.filter(route => 
          route.dep === code || route.arr === code
        );
        
        const aircraftSet = new Set();
        connectedRoutes.forEach(route => {
          route.aircraft.forEach(ac => {
            aircraftSet.add(ac.name);
          });
        });
        
        let aircraftList = '';
        if (aircraftSet.size > 0) {
          aircraftList = '<br><strong>Aircraft:</strong><br>';
          Array.from(aircraftSet).forEach(aircraft => {
            aircraftList += `<div style="font-size: 12px; margin: 1px 0;">${airline.name} ${aircraft}</div>`;
          });
        }
        
        marker.bindPopup(
          `<div style="min-width: 180px;"><strong>${ap.name}</strong><br>${ap.icao}${isHub ? `<br><em>${airline.name} Hub</em>` : ''}${aircraftList}</div>`
        );

        markers[code] = marker;

        marker.on("click", () => {
          highlightAirport(code);
        });
      });
      
      if (Object.keys(airportData).length > 0) {
        map.fitBounds(
          Object.values(airportData).map((a) => [a.lat, a.lng]),
          {
            padding: [40, 40],
            maxZoom: 3,
          }
        );
      }
    }

    // Search functionality
    const searchInput = document.getElementById("airportSearch");
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        const q = searchInput.value.trim().toLowerCase();
        if (!q) {
          Object.values(markers).forEach((m) =>
            m.setStyle({ fillOpacity: 0.9, opacity: 1, radius: 6 })
          );
          return;
        }
        
        const found = Object.keys(markers).find(code => 
          code.toLowerCase().includes(q)
        );
        
        if (found && markers[found]) {
          markers[found].fire('click');
        }
      });
    }
  </script>
</Layout>
